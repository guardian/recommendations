# Vulnerability Management

Writing secure software is hard. Unfortunately for Developers, the days when this bit could be handed off to another team
are long gone. [DevSecOps](https://www.csoonline.com/article/3245748/what-is-devsecops-developing-more-secure-applications.html)
is a fairly established thing these days which is the idea that application and infrastructure security should be thought
about 'from the start' - by the people writing the software.

The other big thing in DevSecOps is that security should be  automated so it doesn't slow development teams down. A great
example of automated security at The Guardian is [Janus](https://github.com/guardian/janus). Unfortunately  there are some
tasks that can't easily be automated, or we haven't got round to automating yet. These areas are discussed below.

## Infrastructure vulnerabilities
There are 5 tools to focus on in this section. They are in rough order of priority. There are also some **critical vulnerabilities**
which should always be addressed first. These are:

 - Unnecessarily exposed security groups (audit via [Security HQ](https://github.com/guardian/security-hq/blob/main/hq/markdown/vulnerability-management.md#1-security-hq))
 - IAM users with a password but no multi factor authentication (audit via [Security HQ](https://github.com/guardian/security-hq/blob/main/hq/markdown/vulnerability-management.md#1-security-hq))
 - IAM users with permanent credentials - these should be regularly rotated or deleted (audit via [Security HQ](https://github.com/guardian/security-hq/blob/main/hq/markdown/vulnerability-management.md#1-security-hq))
 - Critical vulnerabilities identified by [AWS Security Hub](https://github.com/guardian/security-hq/blob/main/hq/markdown/vulnerability-management.md#4-aws-security-hub)
 - Out of date AMIs (audit via [amiable](https://amiable.gutools.co.uk)), [operating systems patches](https://github.com/guardian/security-hq/blob/main/hq/markdown/vulnerability-management.md#2-operating-system-patches)


### 1. Security HQ
The first step of your long journey to the fountain of security involves a visit to [Security HQ](https://security-hq.gutools.co.uk).
Here, you can review Security Groups, S3 buckets and IAM credentials for your account, and check to see if there are any
problems. *Fix these first*.  

Security HQ helpfully uses the colour RED to indicate stuff that we should be worried about. When it
comes to S3 buckets, there may be a reason a bucket is publicly accessible, but there's a good chance that reason no longer
applies.

##### Security Groups

For security groups, you may have open access to a group if it is the group for a load balancer to a public service. 
Otherwise, there should be some restrictions in place. There's no reason to allow open access to any EC2 instances - they
should ideally be locked down to the load balancer and nothing else. Port 22 access should be removed everywhere.  

##### S3 Buckets

Security group and S3 bucket warnings in Security HQ are powered by AWS Trusted Advisor. If  there is a bucket you believe
is correctly public or a security group that is correctly open you can exclude it from the trusted advisor report by going to
the [dashboard](https://console.aws.amazon.com/trustedadvisor/home?region=eu-west-1#/category/security), waiting for everything to load
then finding your bucket or group and clicking 'exclude'.

##### Permanent IAM Credentials

Permanent credentials allow access to AWS, either with a username, password and multi-factor authentication (MFA) or with an access key. They are created manually by AWS account admins. 

Largely at the Guardian most of us use temporary AWS credentials which we get through Janus, but some AWS accounts may have permanent credentials for humans as an emergency option only for the eventuality that Janus-enabled access is not available (eg a Google auth outage). 
We recommend that for most accounts 2 permanent credentials is sufficient to manage this case.

Credentials without a password and with access keys only are typically for machine users and can be used for interacting with APIs. If possible, we do not recommend the use of permanent machine users. For most use cases an IAM role can be assumed by the system requiring access.

In the case that Permanent IAM credentials are required, they must be rotated regularly; at least 90 days for human users (users with a password) and 365 days for machine users. Also, all human users must enable MFA.
Ideally, users should not exist with both password and access key access.

Security HQ will automatically disable active access keys and remove the passwords of permanent IAM credentials which do not meet these requirements. To avoid any unwanted disablements, please regularly check [Security HQ's IAM dashboard]((https://security-hq.gutools.co.uk/iam)) and rectify any warnings.
Also, ensure that [Anghammarad's mapping](https://github.com/guardian/anghammarad#mappings) between your AWS account and the email address attached to it is correct. This means that you'll receive email notifications from Security HQ before it disables any vulnerable users in your account.


### 2. Operating system patches
You should be regularly replacing your AMIs to get the latest security patches. At present, our advice here is to use 
[AMIable](amiable.gutools.co.uk/) to check the status of the AMIs used in your account. Most of our apps should be automatically
on a recent AMI thanks to using a combination of riffraff scheduled deploys and riffraff [ami-cloudformation-parameter](https://riffraff.gutools.co.uk/docs/magenta-lib/types#amicloudformationparameter)
deploy steps. If your app isn't deployed via riffraff then it might be more difficult to keep it up to date. Ideally there
needs to be some kind of process, even if it's just a manual step when AMIable emails you about the out of date instances.

### 3. AWS Security Hub
Security Hub has a LOT of information. Right now we're only interested in the [AWS Foundational Security Best Practices](https://eu-west-1.console.aws.amazon.com/securityhub/home?region=eu-west-1#/standards/aws-foundational-security-best-practices-1.0.0)
section, with a focus on 'Critical' and 'High' severity vulnerabilities. Please note that the previous link is to an internal AWS tool. You will need to authenticated on the account you are interested in before it will work.

We've documented a fair few of the [common Security Hub issues](https://github.com/guardian/security-hq/blob/main/hq/markdown/guardduty-sechub-common-problems.md). 
If something's missing please tell us: devx.sec.ops@theguardian.com

:exclamation: Security Hub raises a large number of issues. For now focus only on 'High' and 'Critical' severity issues


### 4. AWS GuardDuty
![guard gromit](./gromit.gif)

If you're signed in to AWS already, you can click [here](https://eu-west-1.console.aws.amazon.com/guardduty/home?region=eu-west-1#/findings?macros=current)
to take a look at AWS GuardDuty. You'll likely see a big list of activity going on in your AWS account that has been identified
as concerning. The tool isn't infallible -
for instance in the deploy tools account it flagged a load of instances as having unauthorised connections to the Tor
network, but it turns out those instances are the ones we use for secure drop! So take it with some scepticism but 
there's likely to be a fair number things to address here. 

Common problems raised by GuardDuty, [documentation on what you do to resolve them](https://github.com/guardian/security-hq/blob/main/hq/markdown/guardduty-sechub-common-problems.md). 

:exclamation: GuardDuty raises a large number of issues. For now focus only on 'High' severity issues

### 5. Google Cloud Platform Security Command Centre
If your team has any google cloud platform projects, head to [Security HQ](https://security-hq.gutools.co.uk/gcp) to check for any
vulnerabilities identified by Security Command Centre (SCC). At the moment the amount of information it provides is a little
overwhelming - we're working on adding filters. As with Guard Duty and Security Hub this information is robot powered so
may contain false positives etc. We recommend focussing on 'High' severity vulnerabilities for now.

Note that it's not possible to view the SCC findings in the GCP console so if you have any problems with the Security HQ UI please
let us know. 

## Vulnerabilities via 3rd party libraries
![guard gromit](xkcd-dependency.png)


(Credit [xkcd.com](https://xkcd.com))

This type of vulnerability will likely be the most time consuming to keep on top of. Pretty much every major open source
library will at some point need updating to fix a security concern. Most of the time this should be as simple as changing
a version number in your build.sbt or package.json file, but it could involve days of work upgrading, for example, your
version of the Play! Framework. The (draft) standard for Patch Management at The Guardian states:

 ```
All GNM managed third party applications must be patched on a regular basis as patches are released.

Technical owners are responsible to establish such a process.
```  
### 1. Find the vulnerabilities
At The Guardian we recommend 2 vulnerability scanners: Snyk and Dependabot. All PROD applications should have a vulnerability
scanner installed - this should be possible to do in a few clicks in the Snyk/Github UI (see below for details).

#### Snyk
The Guardian has an enterprise account with Snyk, which will scan your repo for vulnerabilities and open PRs where possible
to resolve them. This is the recommended tool for Scala projects. We have unlimited scans with Snyk so you shouldn't
hesitate to enable it in your project. See the [full documentation](./snyk.md). For a summary of all Snyk vulnerabilities
at The Guardian in one place you can head to the [Snyk dashboard on Security HQ](https://security-hq.gutools.co.uk/snyk) 
(VPN required).

#### Dependabot
Dependabot is a similar tool by Github. It opens automated PRs, but you can also see more detail, including any PRs that have been 
ignored/closed in the 'Security' tab of your repo. One downside of Dependabot is that there's no API or central dashboard, so the only way of checking dependency issues is by going to each repo one by one.
 
One thing to note is that dependabot will tell you when there's a new version of a library even if there isn't a security
concern. If you're trying to save time you might opt to skip these - any security related fixes will say so in the PR
description.  
 
### 2. Prioritise the vulnerabilities
Soo, your team should have some kind of process for staying up to date with patching. Not every vulnerability highlighted by
Snyk or Dependabot necessarily needs fixing - maybe the way your app works (e.g. in a private VPC) means that the vulnerability
listed isn't of concern. However, in many cases it's easier to fix rather than to justify not fixing something though, and in general
it's good to have 'defence in depth' - so to assume that any other security measures might get compromised and not to rely on
e.g. network security. 

:exclamation: Updating dependencies can be expensive. Focus on 'high' severity vulnerabilities to begin with. It may be
perfectly reasonable to not fix something if you have a justification.

### 3. Fix them!

This can be the slow, hard part! In future, there might be links to docs on dealing with e.g. awkward play upgrades,
dodgy AWS SDK dependencies, but for now all we can say is 

![good luck](good-luck.gif)
